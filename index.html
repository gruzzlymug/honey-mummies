
<!DOCTYPE HTML>
<html>
  <head>
    <title>honeymummies</title>
    <script src="js/boid.js"></script>
    <script src="js/lib/state-machine.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <canvas id="field" tabindex="1" width="500" height="500" style="outline:none"></canvas>
    <script>
      var canvas = document.getElementById('field');
      var context = canvas.getContext('2d');
      var last = performance.now();

      context.canvas.width = window.innerWidth;
      context.canvas.height = window.innerHeight;

      var t = 0;
      var dv = [0, 0];
      var dp = [0, 0];

      var uiText = "";

      // convenience function for console debugger (use in watch window)
      function o(vec) {
        return truncate(vec[0], 4) + ", " + truncate(vec[1], 4);
      }

      function truncate(num, numDigits) {
        var multiplier = Math.pow(10, numDigits);
        var adjNum = num * multiplier;
        var truncatedNum = Math[adjNum < 0 ? 'ceil' : 'floor'](adjNum);
        return truncatedNum / multiplier;
      }

      function randomInRange(min, max, wantInt) {
        var max = (max === 0 || max) ? max : 1,
            min = min || 0,
            gen = min + (max - min) * Math.random();

        return (wantInt) ? Math.round(gen) : gen;
      }

      function drawUI() {
        context.font = '16pt Futura';
        context.fillStyle = "silver";
        context.fillText(uiText, 1, 20);
      }

      function step(timestamp) {
        var progress = timestamp - last;
        last = timestamp;
        var dt = progress / 100;

        context.fillStyle = "#000000";
        context.fillRect(0, 0, canvas.width, canvas.height);
        // context.clearRect(0, 0, canvas.width, canvas.height);

        f.update(dt);
        f.move(context);
        f.draw(context);

        drawUI();

        window.requestAnimationFrame(step);
      }

      function handleKeyDown(e) {
        var key = e.keyCode;
        if (key == 8) {
          uiText = uiText.substring(0, uiText.length - 1);
          return false;
        }
        uiText += String.fromCharCode((96<=key && key<=105)? key-48 : key);
        // console.log(e.keyCode);
      }

      var fsm = StateMachine.create({
        initial: 'green',
        events: [
          { name: 'warn',  from: 'green',  to: 'yellow' },
          { name: 'panic', from: 'yellow', to: 'red'    },
          { name: 'calm',  from: 'red',    to: 'yellow' },
          { name: 'clear', from: 'yellow', to: 'green'  }
      ]});

      var f = new Flock();
      f.createSource(50, 50);
      f.createSink(50, 250);
      f.createSink(50, 400);
      f.createSink(250, 600);
      f.createBoids(900);

      canvas.addEventListener('keydown', handleKeyDown, false);

      canvas.addEventListener('click', function() {
        var data = {
          operation: "create"
        };

        f.toggleHidden();
        if (false) {
          $.ajax({
            url: "https://shjsc38xsl.execute-api.us-west-2.amazonaws.com/prod/honeymummiesresource",
            type: "GET",
            crossDomain: true,
            contentType: 'application/json',
            success: function(data) {
              alert(data);
            },
            error: function(xhr, ajaxOptions, thrownError) {
              // TODO improve error handling
              consoleo.log('ERROR');
            }
          });
        }
      }, false);
      window.requestAnimationFrame(step);
    </script>
  </body>
</html>

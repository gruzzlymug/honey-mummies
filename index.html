
<!DOCTYPE HTML>
<html>
  <head>
    <title>honeymummies</title>
    <script src="js/boid.js"></script>
    <script src="js/lib/state-machine.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
  </head>
  <body>
    <canvas id="field" tabindex="1" width="500" height="500" style="outline:none"></canvas>
    <script>
      var canvas = document.getElementById('field');
      var context = canvas.getContext('2d');
      var last = performance.now();

      context.canvas.width = window.innerWidth;
      context.canvas.height = window.innerHeight;

      var t = 0;
      var dv = [0, 0];
      var dp = [0, 0];

      var uiText = "";

      // convenience function for console debugger (use in watch window)
      function o(vec) {
        return truncate(vec[0], 4) + ", " + truncate(vec[1], 4);
      }

      function truncate(num, numDigits) {
        var multiplier = Math.pow(10, numDigits);
        var adjNum = num * multiplier;
        var truncatedNum = Math[adjNum < 0 ? 'ceil' : 'floor'](adjNum);
        return truncatedNum / multiplier;
      }

      function randomInRange(min, max, wantInt) {
        var max = (max === 0 || max) ? max : 1,
            min = min || 0,
            gen = min + (max - min) * Math.random();

        return (wantInt) ? Math.round(gen) : gen;
      }

      function step(timestamp) {
        var progress = timestamp - last;
        last = timestamp;
        var dt = progress / 100;

        context.fillStyle = "cornflowerblue";
        context.fillRect(0, 0, canvas.width, canvas.height);
        // context.clearRect(0, 0, canvas.width, canvas.height);

        f.update(dt);
        f.move(context);
        f.draw(context);

        drawUI();

        window.requestAnimationFrame(step);
      }

      function drawUI() {
        if (menuFsm.current == 'active') {
          context.font = '12pt Futura';
          context.fillStyle = "white";
          context.fillText(menuFsm.current, 1, 20);
          context.fillText(uiText, 1, 40);


          context.font = '8pt Futura';
          context.fillStyle = "white";
          var boidCounterText = "boids: " + f.numActive;
          var textDim = context.measureText(boidCounterText)
          context.fillText(boidCounterText, 1, context.canvas.height - 2);
        }
      }

      function handleKeyDown(e) {
        var key = e.keyCode;
        if (key == 8) {
          uiText = uiText.substring(0, uiText.length - 1);
          return false;
        }
        // uiText += String.fromCharCode((96<=key && key<=105)? key-48 : key);
        uiText += String.fromCharCode(key);
      }

      function handleMouseClick(e) {
        getMousePos(e);

        Flock.prototype.sources[0][0] = mouseX;
        Flock.prototype.sources[0][1] = mouseY;

        var data = {
          operation: "create"
        };

        f.toggleHidden();
        menuFsm.current == 'hidden' ? menuFsm.open() : menuFsm.close()

        if (false) {
          $.ajax({
            url: "https://shjsc38xsl.execute-api.us-west-2.amazonaws.com/prod/honeymummiesresource",
            type: "GET",
            crossDomain: true,
            contentType: 'application/json',
            success: function(data) {
              alert(data);
            },
            error: function(xhr, ajaxOptions, thrownError) {
              // TODO improve error handling
              consoleo.log('ERROR');
            }
          });
        }
      }

      function getMousePos(e) {
        if (e.pageX || e.pageY == 0) {
          mouseX = e.pageX - e.target.offsetLeft;
          mouseY = e.pageY - e.target.offsetTop;
        } else if (e.offsetX || e.offsetY == 0) {
          mouseX = e.offsetX;
          mouseY = e.offsetY;
        }
      }

      var menuFsm = StateMachine.create({
        initial: 'hidden',
        events: [
          { name: 'open',  from: 'hidden', to: 'active' },
          { name: 'close', from: 'active', to: 'hidden' }
        ]
      });

      var mouseX = 0;
      var mouseY = 0;

      var f = new Flock();
      f.createSource(context.canvas.width / 2, context.canvas.height / 2);
      // f.createSource(context.canvas.width / 2, context.canvas.height - 20);
      // f.createSource(context.canvas.width / 2, 20);
      // f.createSource(context.canvas.width - 20, context.canvas.height / 2);
      // f.createSource(20, context.canvas.height / 2);
      var sinkOffset = 40;
      f.createSink(sinkOffset, sinkOffset);
      f.createSink(context.canvas.width - sinkOffset, sinkOffset);
      f.createSink(sinkOffset, context.canvas.height - sinkOffset);
      f.createSink(context.canvas.width - sinkOffset, context.canvas.height - sinkOffset);
      f.createBoids(500);

      canvas.addEventListener('keydown', handleKeyDown, false);
      canvas.addEventListener('click', handleMouseClick, false);

      window.requestAnimationFrame(step);
    </script>
  </body>
</html>
